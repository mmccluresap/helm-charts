{{- $envAll := . }}
{{- $firstHSM := dict }}
{{- range $i, $hsm := $envAll.Values.hsm.vendors }}
  {{- if and $hsm.enabled $hsm.name }}
    {{- if not $firstHSM.name }}
      {{- $_ := set $firstHSM "hsm" $hsm }}
    {{- end }}
---
{{ tuple $envAll $hsm | include "hsm_deployment" }}
---
{{ tuple $envAll $hsm | include "hsm_configmap" }}
---
{{ tuple $envAll $hsm | include "hsm_ingress" }}
---
{{ tuple $envAll $hsm | include "hsm_service" }}
  {{- end }}
{{- end }}

{{- if $firstHSM.hsm }}
---
{{ tuple $envAll $firstHSM.hsm | include "hsm_migration_job" }}
{{- end }}
